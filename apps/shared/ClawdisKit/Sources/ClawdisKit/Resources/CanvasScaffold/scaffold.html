<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Canvas</title>
    <style>
      :root { color-scheme: dark; }
      @media (prefers-reduced-motion: reduce) {
        body::before, body::after { animation: none !important; }
      }
      html,body { height:100%; margin:0; }
      body {
        background:
          radial-gradient(1200px 900px at 15% 20%, rgba(42, 113, 255, 0.18), rgba(0,0,0,0) 55%),
          radial-gradient(900px 700px at 85% 30%, rgba(255, 0, 138, 0.14), rgba(0,0,0,0) 60%),
          radial-gradient(1000px 900px at 60% 90%, rgba(0, 209, 255, 0.10), rgba(0,0,0,0) 60%),
          #000;
        overflow: hidden;
      }
      body::before {
        content:"";
        position: fixed;
        inset: -20%;
        background:
          repeating-linear-gradient(0deg, rgba(255,255,255,0.03) 0, rgba(255,255,255,0.03) 1px,
                                 transparent 1px, transparent 48px),
          repeating-linear-gradient(90deg, rgba(255,255,255,0.03) 0, rgba(255,255,255,0.03) 1px,
                                 transparent 1px, transparent 48px);
        transform: translate3d(0,0,0) rotate(-7deg);
        will-change: transform, opacity;
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
        opacity: 0.45;
        pointer-events: none;
        animation: clawdis-grid-drift 140s ease-in-out infinite alternate;
      }
      body::after {
        content:"";
        position: fixed;
        inset: -35%;
        background:
          radial-gradient(900px 700px at 30% 30%, rgba(42,113,255,0.16), rgba(0,0,0,0) 60%),
          radial-gradient(800px 650px at 70% 35%, rgba(255,0,138,0.12), rgba(0,0,0,0) 62%),
          radial-gradient(900px 800px at 55% 75%, rgba(0,209,255,0.10), rgba(0,0,0,0) 62%);
        filter: blur(28px);
        opacity: 0.52;
        will-change: transform, opacity;
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
        transform: translate3d(0,0,0);
        pointer-events: none;
        animation: clawdis-glow-drift 110s ease-in-out infinite alternate;
      }
      @supports (mix-blend-mode: screen) {
        body::after { mix-blend-mode: screen; }
      }
      @supports not (mix-blend-mode: screen) {
        body::after { opacity: 0.70; }
      }
      @keyframes clawdis-grid-drift {
        0%   { transform: translate3d(-12px, 8px, 0) rotate(-7deg); opacity: 0.40; }
        50%  { transform: translate3d( 10px,-7px, 0) rotate(-6.6deg); opacity: 0.56; }
        100% { transform: translate3d(-8px,  6px, 0) rotate(-7.2deg); opacity: 0.42; }
      }
      @keyframes clawdis-glow-drift {
        0%   { transform: translate3d(-18px, 12px, 0) scale(1.02); opacity: 0.40; }
        50%  { transform: translate3d( 14px,-10px, 0) scale(1.05); opacity: 0.52; }
        100% { transform: translate3d(-10px,  8px, 0) scale(1.03); opacity: 0.43; }
      }
      canvas {
        position: fixed;
        inset: 0;
        display:block;
        width:100vw;
        height:100vh;
        touch-action: none;
        z-index: 1;
      }
      #clawdis-status {
        position: fixed;
        inset: 0;
        display: grid;
        place-items: center;
        pointer-events: none;
        z-index: 3;
      }
      #clawdis-a2ui-wrap {
        position: fixed;
        inset: 0;
        display: none;
        z-index: 2;
      }
      #clawdis-a2ui-wrap clawdis-a2ui-host {
        display: block;
        height: 100%;
      }
      #clawdis-status .card {
        text-align: center;
        padding: 16px 18px;
        border-radius: 14px;
        background: rgba(18, 18, 22, 0.42);
        border: 1px solid rgba(255,255,255,0.08);
        box-shadow: 0 18px 60px rgba(0,0,0,0.55);
        -webkit-backdrop-filter: blur(14px);
        backdrop-filter: blur(14px);
      }
      #clawdis-status .title {
        font: 600 20px -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", system-ui, sans-serif;
        letter-spacing: 0.2px;
        color: rgba(255,255,255,0.92);
        text-shadow: 0 0 22px rgba(42, 113, 255, 0.35);
      }
      #clawdis-status .subtitle {
        margin-top: 6px;
        font: 500 12px -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
        color: rgba(255,255,255,0.58);
      }
    </style>
  </head>
  <body>
    <canvas id="clawdis-canvas"></canvas>
    <div id="clawdis-status">
      <div class="card">
        <div class="title" id="clawdis-status-title">Ready</div>
        <div class="subtitle" id="clawdis-status-subtitle">Waiting for agent</div>
      </div>
    </div>
    <div id="clawdis-a2ui-wrap">
      <clawdis-a2ui-host></clawdis-a2ui-host>
    </div>
    <script>
      (() => {
        const canvas = document.getElementById('clawdis-canvas');
        const ctx = canvas.getContext('2d');
        const statusEl = document.getElementById('clawdis-status');
        const titleEl = document.getElementById('clawdis-status-title');
        const subtitleEl = document.getElementById('clawdis-status-subtitle');

        function resize() {
          const dpr = window.devicePixelRatio || 1;
          const w = Math.max(1, Math.floor(window.innerWidth * dpr));
          const h = Math.max(1, Math.floor(window.innerHeight * dpr));
          canvas.width = w;
          canvas.height = h;
          ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        }

        window.addEventListener('resize', resize);
        resize();

        window.__clawdis = {
          canvas,
          ctx,
          setStatus: (title, subtitle) => {
            if (!statusEl) return;
            if (!title && !subtitle) {
              statusEl.style.display = 'none';
              return;
            }
            statusEl.style.display = 'grid';
            if (titleEl && typeof title === 'string') titleEl.textContent = title;
            if (subtitleEl && typeof subtitle === 'string') subtitleEl.textContent = subtitle;
            // Auto-hide after 3 seconds.
            clearTimeout(window.__statusTimeout);
            window.__statusTimeout = setTimeout(() => {
              statusEl.style.display = 'none';
            }, 3000);
          }
        };
      })();

      (() => {
        const wrap = document.getElementById('clawdis-a2ui-wrap');
        if (!wrap) return;

        const candidates = [
          // iOS (SwiftPM resources flattened)
          "a2ui.bundle.js",
          // Android (assets keep directory structure)
          "../CanvasA2UI/a2ui.bundle.js",
          "CanvasA2UI/a2ui.bundle.js",
        ];

        const loadScript = (src) =>
          new Promise((resolve, reject) => {
            const el = document.createElement("script");
            el.src = src;
            el.async = true;
            el.onload = () => resolve();
            el.onerror = () => reject(new Error(`failed to load ${src}`));
            document.head.appendChild(el);
          });

        const sleep = (ms) => new Promise((r) => setTimeout(r, ms));

        const installVisibilityHooks = () => {
          const api = globalThis.clawdisA2UI;
          if (!api || typeof api.applyMessages !== "function") return false;
          if (globalThis.__clawdisA2UIVisibilityHooksInstalled) return true;
          globalThis.__clawdisA2UIVisibilityHooksInstalled = true;

          const show = () => { wrap.style.display = "block"; };
          const hide = () => { wrap.style.display = "none"; };

          const sync = () => {
            try {
              const surfaces =
                typeof api.getSurfaces === "function" ? api.getSurfaces() : [];
              if (Array.isArray(surfaces) && surfaces.length > 0) show();
              else hide();
            } catch {
              hide();
            }
          };

          const origApply = api.applyMessages.bind(api);
          api.applyMessages = (messages) => {
            const res = origApply(messages);
            sync();
            return res;
          };
          const origReset = api.reset.bind(api);
          api.reset = () => {
            const res = origReset();
            hide();
            return res;
          };

          hide();
          return true;
        };

        (async () => {
          if (globalThis.clawdisA2UI) {
            installVisibilityHooks();
            return;
          }

          let loaded = false;
          for (const src of candidates) {
            try {
              await loadScript(src);
              loaded = true;
              break;
            } catch {
              // try next
            }
          }
          if (!loaded) return;

          // Wait for custom element upgrade + connectedCallback to publish globalThis.clawdisA2UI.
          for (let i = 0; i < 60; i += 1) {
            if (installVisibilityHooks()) return;
            await sleep(50);
          }
        })().catch(() => {});
      })();
    </script>
  </body>
</html>
